//code written by Shruti to set attributes which will be used for conditionalities in CA Document 
// changes done by Shruti on 29th jan 2020 for SYMINT-4175 to add upgrade transaction type
//changes done by shruti on 9th june 2020 for VIPER-874 to remove SE and replace it with SK
//changes done by Shruti on 26th june, 2020 for VIPER-914 - Document Output: New Product Line SK for CA Security Products(HW and Distributed Tables)
// changes done by Shruti on 18th Aug 2020 for viper-964 - CPQ: Update QQ template logic for Hosting/Support and SW Upgrades
newMainframe = 0;
newDistributed=0;
newDistributedEnvironment=0;
newSaas=0;
capMainframe = 0;
capDistributed=0;
capDistributedEnvironment=0;
capSaas=0;
renewMainframe=0;
renewDistributed=0;
renewDistributedEnv=0;
renewSaas=0;
newHardware = 0;
capacityHardware = 0;
renewHardware = 0;
mainframeTable=0;
result="";
dlim="~";
dend="|";


// code written by Shruti to set attributes which will be used for conditionalities in CA Document 
// changes done by Shruti on 18th Aug 2020 for viper-964 - CPQ: Update QQ template logic for Hosting/Support and SW Upgrades
for line in transactionLine{


  if((line.transactionTypeM_l == "New" OR line.transactionTypeM_l == "Capacity" OR line.transactionTypeM_l == "Upgrade") AND line.pL_l== "MF" AND line.productGroup_l <> "SaaS" AND NOT(line.dropProduct_l)){
  newMainframe = newMainframe + 1;
  }
  //change SE to SK for VIPER-874
  //change for VIPER-914 : Adding condition to exclude Hardware product groups.
  elif((line.transactionTypeM_l == "New" OR line.transactionTypeM_l == "Capacity" OR line.transactionTypeM_l == "Upgrade") AND ((line.pL_l== "ES") OR (line.pL_l== "SK" AND line.productGroup_l <> "Hardware")) AND line.enterEnvironment_l=="" AND line.productGroup_l <> "SaaS" AND NOT(line.dropProduct_l)){
  newDistributed = newDistributed + 1;
  }
  //change SE to SK for VIPER-874
  //change for VIPER-914 : Adding condition to exclude Hardware product groups.
  elif((line.transactionTypeM_l == "New" OR line.transactionTypeM_l == "Capacity" OR line.transactionTypeM_l == "Upgrade")  AND ((line.pL_l== "ES") OR (line.pL_l== "SK" AND line.productGroup_l <> "Hardware")) AND line.enterEnvironment_l<>""  AND line.productGroup_l <> "SaaS" AND NOT(line.dropProduct_l)){
  newDistributedEnvironment = newDistributedEnvironment + 1;
  }
  elif((line.transactionTypeM_l == "New" OR line.transactionTypeM_l == "Capacity" OR line.transactionTypeM_l == "Upgrade")  AND line.productGroup_l == "SaaS" AND NOT(line.dropProduct_l)){
  newSaas = newSaas + 1;
  }
  // code written by Shruti to set attributes which will be used for Hardware Table conditionalities in CA Document as part of VIPER-593
  // changes done by Shruti on 29th jan 2020 for SYMINT-4175 to add upgrade transaction type
  //change for VIPER-914 : Adding condition to include SK product line.
  elif((line.transactionTypeM_l == "New" OR line.transactionTypeM_l == "Capacity" OR line.transactionTypeM_l == "Upgrade")  AND (line.pL_l== "SF" OR line.pL_l== "SK") AND line.productGroup_l == "Hardware" AND NOT(line.dropProduct_l)){
  newHardware = newHardware + 1;
  }


  elif((line.transactionTypeM_l == "Renew") AND line.pL_l== "MF" AND line.productGroup_l <> "SaaS" AND NOT(line.dropProduct_l)){
  renewMainframe = renewMainframe + 1;
  }
  //change SE to SK for VIPER-874
  //change for VIPER-914 : Adding condition to exclude Hardware product groups.
  elif((line.transactionTypeM_l == "Renew") AND ((line.pL_l== "ES") OR (line.pL_l== "SK" AND line.productGroup_l <> "Hardware")) AND line.enterEnvironment_l=="" AND line.productGroup_l <> "SaaS" AND NOT(line.dropProduct_l)){
  renewDistributed = renewDistributed + 1;
  }
  //change SE to SK for VIPER-874
  //change for VIPER-914 : Adding condition to exclude Hardware product groups.
  elif((line.transactionTypeM_l == "Renew") AND ((line.pL_l== "ES") OR (line.pL_l== "SK" AND line.productGroup_l <> "Hardware")) AND line.enterEnvironment_l<>""AND line.productGroup_l <> "SaaS" AND NOT(line.dropProduct_l)){
  renewDistributedEnv = renewDistributedEnv + 1;
  }
  elif((line.transactionTypeM_l == "Renew")  AND line.productGroup_l == "SaaS" AND NOT(line.dropProduct_l)){
  renewSaas = renewSaas + 1;
  }
  // code written by Shruti to set attributes which will be used for Hardware Table conditionalities in CA Document as part of VIPER-593
  //change for VIPER-914 : Adding condition to include SK product line.
  elif(line.transactionTypeM_l == "Renew"  AND (line.pL_l== "SF" OR line.pL_l== "SK") AND line.productGroup_l == "Hardware" AND NOT(line.dropProduct_l)){
  renewHardware = renewHardware + 1;
  }


  if(line.pL_l=="MF"){
  mainframeTable=mainframeTable+1;
  }
  
 }
address1="";
address2="";
address3="";

              headerRecord=bmql("Select OU,Address1,Address2,Address3 from BRCM_Headers where OU=$operatingUnit_t");
           
              for eachRecord in headerRecord{
               address1= get(eachRecord,"Address1");
        address2= get(eachRecord,"Address2");
    address3= get(eachRecord,"Address3");
      }
      //changes done on  13th June 2019 for jira-  4347     
newOwnerEmail = "";
     
     if(newQuoteOwner_t <> ""){
          newOwner = newQuoteOwner_t;
 newOwnerArr = split(newOwner,"~");
 newOwnerEmail = newOwnerArr[1];
 }
 else{
 newOwnerEmail = QuoteownerEmail_t;
 }
 
 
     emailID = "" ; 
     title = "" ; 
     phNo = "" ;      
     resultSet = bmql("select User_Title, User_PhoneNo, EMailID from BRCM_Users where EMailID=$newOwnerEmail");
     for each in resultSet{
     emailID= get(each,"EMailID");
        title= get(each,"User_Title");
    phNo= get(each,"User_PhoneNo");
     }
     // end of changes
           

sb = stringbuilder();
sbappend(sb,"1~newMainframe_t~",string(newMainframe),"|","1~newDistributed_t~",string(newDistributed),"|","1~newDistributedEnvironment_t~",string(newDistributedEnvironment),"|","1~newSaas_t~",string(newSaas),"|","1~newHardware_t~",string(newHardware),"|");

/*sbappend(sb,"1~capacityMainframe_t~",string(capMainframe),"|","1~capacityDistributed_t~",string(capDistributed),"|","1~capacityDistributedEnvironment_t~",string(capDistributedEnvironment),"|","1~capacitySaas_t~",string(capSaas),"|","1~capacityHardware_t~",string(capacityHardware),"|"); */

sbappend(sb,"1~renewMainfram_t~",string(renewMainframe),"|","1~renewDistributed_t~",string(renewDistributed),"|","1~renewDistributedENvironment_t~",string(renewDistributedEnv),"|","1~renewSaas_t~",string(renewSaas),"|","1~renewHardware_t~",string(renewHardware),"|");

sbappend(sb,"1~mainframesTables_avg~",string(mainframeTable),"|");

sbappend(sb,"1~headerLegalAddress_t~",address1,"|","1~headerLegalAddress1_t~",address2,"|","1~headerLegalAddress2_t~",address3,"|");

sbappend(sb,"1~QuoteownerEmail_t~",emailID,"|","1~quoteOwnerPhoneNumber_t~",phNo,"|","1~quoteOwnerTitle_t~",title,"|");

result = sbtostring(sb); 

return result;
//code written by Shruti to set attributes which will be used for conditionalities in CA Document 
// changes done by Shruti on 29th jan 2020 for SYMINT-4175 to add upgrade transaction type
//changes done by shruti on 9th june 2020 for VIPER-874 to remove SE and replace it with SK
//changes done by Shruti on 26th june, 2020 for VIPER-914 - Document Output: New Product Line SK for CA Security Products(HW and Distributed Tables)
// changes done by Shruti on 18th Aug 2020 for viper-964 - CPQ: Update QQ template logic for Hosting/Support and SW Upgrades
newMainframe = 0;
newDistributed=0;
newDistributedEnvironment=0;
newSaas=0;
capMainframe = 0;
capDistributed=0;
capDistributedEnvironment=0;
capSaas=0;
renewMainframe=0;
renewDistributed=0;
renewDistributedEnv=0;
renewSaas=0;
newHardware = 0;
capacityHardware = 0;
renewHardware = 0;
mainframeTable=0;
result="";
dlim="~";
dend="|";


// code written by Shruti to set attributes which will be used for conditionalities in CA Document 
// changes done by Shruti on 18th Aug 2020 for viper-964 - CPQ: Update QQ template logic for Hosting/Support and SW Upgrades
for line in transactionLine{


  if((line.transactionTypeM_l == "New" OR line.transactionTypeM_l == "Capacity" OR line.transactionTypeM_l == "Upgrade") AND line.pL_l== "MF" AND line.productGroup_l <> "SaaS" AND NOT(line.dropProduct_l)){
  newMainframe = newMainframe + 1;
  }
  //change SE to SK for VIPER-874
  //change for VIPER-914 : Adding condition to exclude Hardware product groups.
  elif((line.transactionTypeM_l == "New" OR line.transactionTypeM_l == "Capacity" OR line.transactionTypeM_l == "Upgrade") AND ((line.pL_l== "ES") OR (line.pL_l== "SK" AND line.productGroup_l <> "Hardware")) AND line.enterEnvironment_l=="" AND line.productGroup_l <> "SaaS" AND NOT(line.dropProduct_l)){
  newDistributed = newDistributed + 1;
  }
  //change SE to SK for VIPER-874
  //change for VIPER-914 : Adding condition to exclude Hardware product groups.
  elif((line.transactionTypeM_l == "New" OR line.transactionTypeM_l == "Capacity" OR line.transactionTypeM_l == "Upgrade")  AND ((line.pL_l== "ES") OR (line.pL_l== "SK" AND line.productGroup_l <> "Hardware")) AND line.enterEnvironment_l<>""  AND line.productGroup_l <> "SaaS" AND NOT(line.dropProduct_l)){
  newDistributedEnvironment = newDistributedEnvironment + 1;
  }
  elif((line.transactionTypeM_l == "New" OR line.transactionTypeM_l == "Capacity" OR line.transactionTypeM_l == "Upgrade")  AND line.productGroup_l == "SaaS" AND NOT(line.dropProduct_l)){
  newSaas = newSaas + 1;
  }
  // code written by Shruti to set attributes which will be used for Hardware Table conditionalities in CA Document as part of VIPER-593
  // changes done by Shruti on 29th jan 2020 for SYMINT-4175 to add upgrade transaction type
  //change for VIPER-914 : Adding condition to include SK product line.
  elif((line.transactionTypeM_l == "New" OR line.transactionTypeM_l == "Capacity" OR line.transactionTypeM_l == "Upgrade")  AND (line.pL_l== "SF" OR line.pL_l== "SK") AND line.productGroup_l == "Hardware" AND NOT(line.dropProduct_l)){
  newHardware = newHardware + 1;
  }


  elif((line.transactionTypeM_l == "Renew") AND line.pL_l== "MF" AND line.productGroup_l <> "SaaS" AND NOT(line.dropProduct_l)){
  renewMainframe = renewMainframe + 1;
  }
  //change SE to SK for VIPER-874
  //change for VIPER-914 : Adding condition to exclude Hardware product groups.
  elif((line.transactionTypeM_l == "Renew") AND ((line.pL_l== "ES") OR (line.pL_l== "SK" AND line.productGroup_l <> "Hardware")) AND line.enterEnvironment_l=="" AND line.productGroup_l <> "SaaS" AND NOT(line.dropProduct_l)){
  renewDistributed = renewDistributed + 1;
  }
  //change SE to SK for VIPER-874
  //change for VIPER-914 : Adding condition to exclude Hardware product groups.
  elif((line.transactionTypeM_l == "Renew") AND ((line.pL_l== "ES") OR (line.pL_l== "SK" AND line.productGroup_l <> "Hardware")) AND line.enterEnvironment_l<>""AND line.productGroup_l <> "SaaS" AND NOT(line.dropProduct_l)){
  renewDistributedEnv = renewDistributedEnv + 1;
  }
  elif((line.transactionTypeM_l == "Renew")  AND line.productGroup_l == "SaaS" AND NOT(line.dropProduct_l)){
  renewSaas = renewSaas + 1;
  }
  // code written by Shruti to set attributes which will be used for Hardware Table conditionalities in CA Document as part of VIPER-593
  //change for VIPER-914 : Adding condition to include SK product line.
  elif(line.transactionTypeM_l == "Renew"  AND (line.pL_l== "SF" OR line.pL_l== "SK") AND line.productGroup_l == "Hardware" AND NOT(line.dropProduct_l)){
  renewHardware = renewHardware + 1;
  }


  if(line.pL_l=="MF"){
  mainframeTable=mainframeTable+1;
  }
  
 }
address1="";
address2="";
address3="";

              headerRecord=bmql("Select OU,Address1,Address2,Address3 from BRCM_Headers where OU=$operatingUnit_t");
           
              for eachRecord in headerRecord{
               address1= get(eachRecord,"Address1");
        address2= get(eachRecord,"Address2");
    address3= get(eachRecord,"Address3");
      }
      //changes done on  13th June 2019 for jira-  4347     
newOwnerEmail = "";
     
     if(newQuoteOwner_t <> ""){
          newOwner = newQuoteOwner_t;
 newOwnerArr = split(newOwner,"~");
 newOwnerEmail = newOwnerArr[1];
 }
 else{
 newOwnerEmail = QuoteownerEmail_t;
 }
 
 
     emailID = "" ; 
     title = "" ; 
     phNo = "" ;      
     resultSet = bmql("select User_Title, User_PhoneNo, EMailID from BRCM_Users where EMailID=$newOwnerEmail");
     for each in resultSet{
     emailID= get(each,"EMailID");
        title= get(each,"User_Title");
    phNo= get(each,"User_PhoneNo");
     }
     // end of changes
           

sb = stringbuilder();
sbappend(sb,"1~newMainframe_t~",string(newMainframe),"|","1~newDistributed_t~",string(newDistributed),"|","1~newDistributedEnvironment_t~",string(newDistributedEnvironment),"|","1~newSaas_t~",string(newSaas),"|","1~newHardware_t~",string(newHardware),"|");

/*sbappend(sb,"1~capacityMainframe_t~",string(capMainframe),"|","1~capacityDistributed_t~",string(capDistributed),"|","1~capacityDistributedEnvironment_t~",string(capDistributedEnvironment),"|","1~capacitySaas_t~",string(capSaas),"|","1~capacityHardware_t~",string(capacityHardware),"|"); */

sbappend(sb,"1~renewMainfram_t~",string(renewMainframe),"|","1~renewDistributed_t~",string(renewDistributed),"|","1~renewDistributedENvironment_t~",string(renewDistributedEnv),"|","1~renewSaas_t~",string(renewSaas),"|","1~renewHardware_t~",string(renewHardware),"|");

sbappend(sb,"1~mainframesTables_avg~",string(mainframeTable),"|");

sbappend(sb,"1~headerLegalAddress_t~",address1,"|","1~headerLegalAddress1_t~",address2,"|","1~headerLegalAddress2_t~",address3,"|");

sbappend(sb,"1~QuoteownerEmail_t~",emailID,"|","1~quoteOwnerPhoneNumber_t~",phNo,"|","1~quoteOwnerTitle_t~",title,"|");

result = sbtostring(sb); 

return result;