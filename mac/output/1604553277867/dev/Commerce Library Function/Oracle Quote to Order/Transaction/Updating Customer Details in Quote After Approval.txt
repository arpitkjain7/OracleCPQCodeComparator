/********************************************************************
Function Name: Updating Customer Details in  Quote After Approval
Description: This rule is to  populate the customer details on header and also related line leel fields for the approved quotes
Author:   Nandhini Vurimella
History:     Date          Author                    Comment 
      05-14-2020    Nandhini Vurimella            Initial Version
********************************************************************/
sb1=stringbuilder();
sb = stringbuilder();
if(status_t == "APPROVED"){
// initializing the variables
operatingUnit=operatingUnit_t;
ShipToERP=shipToPartyID_t;
ShipToSiteNumber=shipToSiteNumber_t;
EndToERP = customerERPId_t;
EndToSiteNumber = endCustomerSiteNumber_t;
ShipToCity = _transaction_shipTo_t_city;
ShipToZip = _transaction_shipTo_t_zip;
ShipToAddress = _transaction_shipTo_t_address;
EndToAddress = _transaction_customer_t_address;
EndToCity = _transaction_customer_t_city;
EndToZip = _transaction_customer_t_zip;
//VIPER-878
jHashValidation="";
lineCount=0;
 // In this loop we are calling the function to fetch the customer details selected by the customer
 for line in transactionLine
 {
 
 lineCount=lineCount+1;

  //Kacharya@deloitte.com;7/12/2020; VIPER-878: JHASH Validation
  if(line.transactionTypeM_l=="New" and line.token_l=="Yes" and (jHASH_t=="" OR jHASH_t==" "))
  {
  jHashValidation= jHashValidation + string(lineCount) + " ,";
  //jHashValidation="";
  } 
      if(billToCustomerId_t=="" or soldToCustomerAccountID_t=="" or shipToPartyID_t=="" or _transaction_customer_id=="" or line.lineItemComment_avg<>line._line_item_comment or operatingUnit<>operatingUnit_t){
  if(line.lineItemComment_avg<>line._line_item_comment or operatingUnit<>operatingUnit_t)
  {
   if(line._part_number=="Cust" AND line._model_name=="")
   {
    sb1=stringbuilder(sb1,line._document_number,"~lineItemComment_avg~",line._line_item_comment,"|",commerce.fetchCustomerSearchDetails_brcm(line._model_name, line._part_number, line._line_item_comment));
    obj=json(); ShipTo =""; EndTo="";
   if(line._line_item_comment<>"") 
   {
   teststring=line._line_item_comment;
   
   obj=json(teststring);
   ShipTo=jsonget(obj,"SHIP_TO");
   
   EndTo=jsonget(obj,"END_TO");
   }
   // we are getting the ship to and end to details required to populate the fields in the line level
   if(isnull(ShipTo)<>true)
   { 
    ShipToERP=jsonget(json(ShipTo),"Customer ERP Id");//shipToPartyID_t
    ShipToSiteNumber=jsonget(json(ShipTo), "Address Site Use Id");//shipToSiteNumber_t
    ShipToCity= jsonget(json(ShipTo), "City");//_transaction_shipTo_t_city
    ShipToZip= jsonget(json(ShipTo), "Postal Code");//_transaction_shipTo_t_zip,   
    ShipToAddress= jsonget(json(ShipTo), "Address Line 1");//_transaction_shipTo_t_address
   }
   if(isnull(EndTo)<>true)
   {
    EndToERP = jsonget(json(EndTo),"Customer ERP Id");//customerERPId_t
    EndToSiteNumber = jsonget(json(EndTo), "End Customer Site Number");//endCustomerSiteNumber_t
    EndToAddress = jsonget(json(EndTo), "End Customer Address");//_transaction_customer_t_address
    EndToCity = jsonget(json(EndTo), "End Customer City");//_transaction_customer_t_city
    EndToZip = jsonget(json(EndTo), "End Customer Zip");//_transaction_customer_t_zip
   }
   }
   }
  }
 }
 // this loop populates the fields in each line based on the conditions.
 for line in transactionLine
 {
   if(quoteType_t <> "renewalQuote" and quoteType_t<>"contractQuote"){
   
    sbappend(sb,line._document_number,"~installedAtCustomerNumber_l~",ShipToERP,"|");
    sbappend(sb,line._document_number,"~siteID_l~",ShipToSiteNumber,"|");
    sbappend(sb,line._document_number,"~siteIDStreetAddress_l~",ShipToAddress,"|");
    sbappend(sb,line._document_number,"~siteIDCityStateZip_l~",ShipToCity,"|");
    sbappend(sb,line._document_number,"~siteIDZip_l~",ShipToZip,"|");
   }
   if(businessDivision_t=="Symantec" and endCustomerSiteNumber_t <> ""){
       if(line.installedAtCustomerNumber_l==line.temporaryInstalledAtCustomerNumber_avg){
                        sb=sbappend(sb,line._document_number,"~installedAtCustomerNumber_l~",EndToERP,"|"); 
                        sb=sbappend(sb,line._document_number,"~temporaryInstalledAtCustomerNumber_avg~",EndToERP,"|");
                    }
                    if(line.installedAtCustomerNumber_l==""){
                        sb=sbappend(sb,line._document_number,"~installedAtCustomerNumber_l~",EndToERP,"|");   
                        sb=sbappend(sb,line._document_number,"~temporaryInstalledAtCustomerNumber_avg~",EndToERP,"|");
                    }
                    if(line.installedAtCustomerNumber_l<>"" AND line.installedAtCustomerNumber_l<>line.temporaryInstalledAtCustomerNumber_avg){
                        sb=sbappend(sb,line._document_number,"~installedAtCustomerNumber_l~",line.installedAtCustomerNumber_l,"|");
                    }
                    else{
      sb=sbappend(sb,line._document_number,"~installedAtCustomerNumber_l~",EndToERP,"|");
                    }
                    if(line.siteID_l==line.temporarysiteID_avg or line.siteID_l==""){
                        sb=sbappend(sb,line._document_number,"~temporarysiteID_avg~",EndToSiteNumber,"|");
                        sb=sbappend(sb,line._document_number,"~siteID_l~",EndToSiteNumber,"|");
                    }             
                    if(line.siteID_l<>"" AND line.siteID_l<>line.temporarysiteID_avg){
                        sb=sbappend(sb,line._document_number,"~siteID_l~",line.siteID_l,"|");
                    }
                    else{
                        sb=sbappend(sb,line._document_number,"~siteID_l~",EndToSiteNumber ,"|");
                        sb=sbappend(sb,line._document_number,"~temporarysiteID_avg~",EndToSiteNumber,"|");
                    }
                    if(line.siteIDStreetAddress_l==line.temporarysiteIDStreetAddress_avg or line.siteIDStreetAddress_l==""){
                        sb=sbappend(sb,line._document_number,"~siteIDStreetAddress_l~",EndToAddress,"|");
                        sb=sbappend(sb,line._document_number,"~temporarysiteIDStreetAddress_avg~",EndToAddress,"|");
                    }
                    if(line.siteIDStreetAddress_l<>"" AND line.siteIDStreetAddress_l<>line.temporarysiteIDStreetAddress_avg){
                        sb=sbappend(sb,line._document_number,"~siteIDStreetAddress_l~",line.siteIDStreetAddress_l,"|");
                    }
                    else{
                        sb=sbappend(sb,line._document_number,"~siteIDStreetAddress_l~",EndToAddress,"|");
     }
                    if(line.siteIDCityStateZip_l==line.temporarysiteIDCityStateZip_avg or line.siteIDCityStateZip_l==""){
                        sb=sbappend(sb,line._document_number,"~siteIDCityStateZip_l~",EndToCity,"|");
                        sb=sbappend(sb,line._document_number,"~temporarysiteIDCityStateZip_avg~",EndToCity,"|");
                    }
     if(line.siteIDCityStateZip_l<>"" AND line.siteIDCityStateZip_l<>line.temporarysiteIDCityStateZip_avg){
                        sb=sbappend(sb,line._document_number,"~siteIDCityStateZip_l~",line.siteIDCityStateZip_l,"|");
                    }
                    else{
                        sb=sbappend(sb,line._document_number,"~siteIDCityStateZip_l~",EndToCity,"|");
                    }
                    if(line.siteIDZip_l==line.temporarysiteIDZip_avg or line.siteIDZip_l==""){
                        sb=sbappend(sb,line._document_number,"~siteIDZip_l~",EndToZip,"|");
                        sb=sbappend(sb,line._document_number,"~temporarysiteIDZip_avg~",EndToZip,"|");
                    }
                    if(line.siteIDZip_l<>"" AND line.siteIDZip_l<>line.temporarysiteIDZip_avg){
                        sb=sbappend(sb,line._document_number,"~siteIDZip_l~",line.siteIDZip_l,"|");
                    }
                    else{
                        sb=sbappend(sb,line._document_number,"~siteIDZip_l~",EndToZip,"|");
                    }
     }  
  else
  {
      if(line.installedAtCustomerNumber_l==line.temporaryInstalledAtCustomerNumber_avg){
                            sb=sbappend(sb,line._document_number,"~installedAtCustomerNumber_l~",ShipToERP,"|");    
                            sb=sbappend(sb,line._document_number,"~temporaryInstalledAtCustomerNumber_avg~",ShipToERP,"|");
                        }
                        if(line.installedAtCustomerNumber_l==""){
                            sb=sbappend(sb,line._document_number,"~installedAtCustomerNumber_l~",ShipToERP,"|");   
                            sb=sbappend(sb,line._document_number,"~temporaryInstalledAtCustomerNumber_avg~",ShipToERP,"|");
                        }
                        if(line.installedAtCustomerNumber_l<>"" AND line.installedAtCustomerNumber_l<>line.temporaryInstalledAtCustomerNumber_avg){
                            sb=sbappend(sb,line._document_number,"~installedAtCustomerNumber_l~",line.installedAtCustomerNumber_l,"|");
                        }
                        else{
                            sb=sbappend(sb,line._document_number,"~installedAtCustomerNumber_l~",ShipToERP,"|");
                        }
                        if(line.siteID_l==line.temporarysiteID_avg or line.siteID_l==""){
                            sb=stringbuilder(sb,line._document_number,"~temporarysiteID_avg~",ShipToSiteNumber,"|");
                            sb=sbappend(sb,line._document_number,"~siteID_l~",ShipToSiteNumber,"|");
                        }             
                        if(line.siteID_l<>"" AND line.siteID_l<>line.temporarysiteID_avg){
                            sb=sbappend(sb,line._document_number,"~siteID_l~",line.siteID_l,"|");
                        }
                        else{
                            sb=sbappend(sb,line._document_number,"~siteID_l~",ShipToSiteNumber ,"|");
                            sb=sbappend(sb,line._document_number,"~temporarysiteID_avg~",ShipToSiteNumber,"|");
                        }
                        if(line.siteIDStreetAddress_l==line.temporarysiteIDStreetAddress_avg or line.siteIDStreetAddress_l==""){
                            sb=sbappend(sb,line._document_number,"~siteIDStreetAddress_l~",ShipToAddress,"|");
                            sb=sbappend(sb,line._document_number,"~temporarysiteIDStreetAddress_avg~",ShipToAddress,"|");
                        }
                        if(line.siteIDStreetAddress_l<>"" AND line.siteIDStreetAddress_l<>line.temporarysiteIDStreetAddress_avg){
                            sb=sbappend(sb,line._document_number,"~siteIDStreetAddress_l~",line.siteIDStreetAddress_l,"|");
                        }
                        else{
                            sb=sbappend(sb,line._document_number,"~siteIDStreetAddress_l~",ShipToAddress,"|");
                        }
                        if(line.siteIDCityStateZip_l==line.temporarysiteIDCityStateZip_avg or line.siteIDCityStateZip_l==""){
                            sb=sbappend(sb,line._document_number,"~siteIDCityStateZip_l~",ShipToCity,"|");
                            sb=sbappend(sb,line._document_number,"~temporarysiteIDCityStateZip_avg~",ShipToCity,"|");
                        }
                        if(line.siteIDCityStateZip_l<>"" AND line.siteIDCityStateZip_l<>line.temporarysiteIDCityStateZip_avg){
                            sb=sbappend(sb,line._document_number,"~siteIDCityStateZip_l~",line.siteIDCityStateZip_l,"|");
                        }
                        else{
                            sb=sbappend(sb,line._document_number,"~siteIDCityStateZip_l~",ShipToCity,"|");
                        }
                        if(line.siteIDZip_l==line.temporarysiteIDZip_avg or line.siteIDZip_l==""){
                            sb=sbappend(sb,line._document_number,"~siteIDZip_l~",ShipToZip,"|");
                            sb=sbappend(sb,line._document_number,"~temporarysiteIDZip_avg~",ShipToZip,"|");
                        }
                        if(line.siteIDZip_l<>"" AND line.siteIDZip_l<>line.temporarysiteIDZip_avg){
                            sb=sbappend(sb,line._document_number,"~siteIDZip_l~",line.siteIDZip_l,"|");
                        }
                        else{
                            sb=sbappend(sb,line._document_number,"~siteIDZip_l~",ShipToZip,"|");
                        }
                    } 
              }             
//VIPER-878 ; Setting values
 sb=sbappend(sb,"1~jHASHRequired_t~" , jHashValidation , "|"); 
}
sb1=sbappend(sb1,sb);
result=sbtostring(sb1);
return result;