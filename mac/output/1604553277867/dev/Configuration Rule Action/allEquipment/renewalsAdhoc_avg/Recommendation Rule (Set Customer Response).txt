/*****************************************************************
Function Name :Customer Search For Renewal Adhoc Job
Author : Ravi Kumar
Description : This function is a clone from Customer Search Product Family which is used to fetch customer detail from OEC
*****************************************************************/ 

res = "";
sessionId = "";
currentDate= getdate(false);
Filelocation="";
Username="";
Password="";
SOA_ENDPOINTURL="";
userpasscode="";
countryCode="";
quoteType="";

dynXML="";        
//Creating dynamic XML based on different search combinations
 if(customerName_avg<>""){
 dynXML=dynXML+"<typ1:item><typ1:conjunction>And</typ1:conjunction><typ1:upperCaseCompare>true</typ1:upperCaseCompare><typ1:attribute>PartyUniqueName</typ1:attribute><typ1:operator>CONTAINS</typ1:operator><typ1:value>"+customerName_avg+"</typ1:value></typ1:item>";
 }
 if(customerNumber_avg<>""){
 dynXML=dynXML+"<typ1:item><typ1:conjunction>And</typ1:conjunction><typ1:upperCaseCompare>true</typ1:upperCaseCompare><typ1:attribute>OrganizationDEO_BRCM_ERPAccount_c</typ1:attribute><typ1:operator>=</typ1:operator><typ1:value>"+customerNumber_avg+"</typ1:value></typ1:item>";
 }
 /*if(parentName_avg<>""){
 dynXML=dynXML+"<typ1:item><typ1:conjunction>And</typ1:conjunction><typ1:upperCaseCompare>true</typ1:upperCaseCompare><typ1:attribute>OrganizationDEO_BRCM_ParentName_c</typ1:attribute><typ1:operator>CONTAINS</typ1:operator><typ1:value>"+parentName_avg+"</typ1:value></typ1:item>";
 }
 if(country_avg_cs<>""){
 dynXML=dynXML+"<typ1:item><typ1:conjunction>And</typ1:conjunction><typ1:upperCaseCompare>true</typ1:upperCaseCompare><typ1:attribute>Country</typ1:attribute><typ1:operator>CONTAINS</typ1:operator><typ1:value>"+countryCode+"</typ1:value></typ1:item>";
 }
 if(salesArea_avg<>""){
 dynXML=dynXML+"<typ1:item><typ1:conjunction>And</typ1:conjunction><typ1:upperCaseCompare>true</typ1:upperCaseCompare><typ1:attribute>OrganizationDEO_BRCM_SalesArea_New_c</typ1:attribute><typ1:operator>CONTAINS</typ1:operator><typ1:value>"+salesArea_avg+"</typ1:value></typ1:item>";
 }
 //added code to fetch customer detail for contract quote independent of OU on 8th july by Rohit Ranjan for jira id:5449 
 
 if(quoteType<>"contractQuote"){
 dynXML=dynXML+"<typ1:item><typ1:conjunction>And</typ1:conjunction><typ1:upperCaseCompare>true</typ1:upperCaseCompare><typ1:attribute>OrganizationDEO_BRCM_ACC_OPERATING_UNIT_c</typ1:attribute><typ1:operator>CONTAINS</typ1:operator><typ1:value>"+operatingUnit_avg+"</typ1:value></typ1:item>";
 }
 */
Details=bmql("SELECT Username, Password, File_Location,SoapEndpoint FROM INT_SYSTEM_DETAILS WHERE System='Customer_Search_NameNumber'");

for detail in Details{
Username=get(detail,"Username");
Password=get(detail,"Password");
Filelocation=get(detail,"File_Location");
SOA_ENDPOINTURL=get(detail,"SoapEndpoint");
userpasscode=Username+":"+Password;
}
quoteRequest= "";
payload = dict("string");
put(payload,"dynXML",dynXML);
str1=encodebase64(userpasscode);

auth="Basic" + " " + str1;

defaultErrorMessage="";
quoteRequest=applytemplate(Filelocation,payload,defaultErrorMessage);
quoteRequest= replace(quoteRequest, "&lt;", "<");
quoteRequest= replace(quoteRequest, "&gt;", ">");
//print quoteRequest;
headersDict = dict("string"); 
put(headersDict,"Content-Type","text/xml;charset=UTF-8"); 
put(headersDict,"Authorization",auth);
response="";
response = urldatabypost(SOA_ENDPOINTURL,quoteRequest, "error",headersDict);
xmlResponse1 = replace(response, "env:", "");
xmlResponse2 = replace(xmlResponse1, "ns0:", "");
xmlResponse3 = replace(xmlResponse2, "ns1:", "");
xmlResponse4 = replace(xmlResponse3, "ns4:", "");
xmlResponse5 = replace(xmlResponse4, "wsa:", "");
xmlResponse6 = trim(xmlResponse5); 

//Commented this code to avoid getting the runtime error if customer is not found in OEC
/*
if(response=="error")
{
 return "error";
}
*/

if(find(xmlResponse6, "<PartyId>")  == -1 ){
 xmlResponse6 = "Not Found";
}

return xmlResponse6;