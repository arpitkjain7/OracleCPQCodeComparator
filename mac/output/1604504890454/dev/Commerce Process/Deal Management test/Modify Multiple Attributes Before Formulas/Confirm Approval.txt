/*****************************************************************
Author - Kavita Lolla
Date - 26/01/2019
UID - 217
USer story summary - Call approve or reject action based on 
   approval status of all lines
*****************************************************************/
ret="";
result="|";
cnt = 0;
//levelup holds the number of approval levels completed.
levelup = approvalLevelCompleted_avg;
prodFam = json();
salesRegion = quoteOwnerSubRegion_t;
buRole = approverRoleLevel3_t;
sb = stringbuilder();
// set the product family based of MF, ES or others
for line in transactionLine 
{
 if(line._part_number == "")
 {
  if(upper(line._model_product_line_name) == "ENTERPRISE SOFTWARE")
  {
   jsonput(prodFam,line._document_number,"ES");
  }
  elif(upper(line._model_product_line_name) == "MAINFRAMES")
  {
   jsonput(prodFam,line._document_number,"MF");
  }
  else
  {
   jsonput(prodFam,line._document_number,line._model_product_line_name);
  }
 }
}

// set the counter based on the line status
for n in transactionLine{
if(n._model_name == ""){
 
 sbappend(sb , n._document_number , "~" , "lineApprovalStatus_l" , "~" , upper(n.workflowStatus_l) , "|");
 if(n.workflowStatus_l <> "approved" AND n.workflowStatus_l <>"pending_approval" and n.workflowStatus_l <>""){
   cnt = 1;
 }
 elif(n.workflowStatus_l <> "approved" AND n.workflowStatus_l <>"rejected"){
 cnt = 2;
 }
}
// if count is 1 , assign rejected
if(cnt == 1)
{
 ret = "rejected";
}
//if count is 2, assign pending approval
elif(cnt == 2){
 ret = "pending_approval";
}
// else assign approved 
else{
 ret = "approved";
}
}

// if block for approved  - approval to move to next level. Hence reassignment of approver to be done.
if(ret == "approved")
{
 approver="";
 workflow="pending_approval";
 hiddenflow = " ";
 levelup = approvalLevelCompleted_avg + 1;
 //1st level of approval is over. Assign level-2 approvers.
 if(levelup == 1)
 {

  for line in transactionLine{
   sbapprover = stringbuilder();
   workflow="pending_approval";

  if (line.approvalFlag_l){
  bu = line.businessDivision_l;
  part = line._part_number;
  if(part<>""){
  //if list price =0 & proposed price > 0, it should go toonly BU approval in the first and then get fully approved.
  if(line.perUnitPerListPrice_l == 0 and line.proposedNetUnitPriceRequested_l > 0){
    approver = "";
   workflow="approved";
  }
  else
  { 
   if(line.proposedNetUnitPriceRequested_l >= line.salesMin2_l)
  {

   sbappend(sbapprover , "");
   workflow="approved";
  }

  else
  {
   sbappend(sbapprover , approverLevel2_t);
  } 
  } 
  approver = sbtostring(sbapprover);
  sbappend(sb , line._document_number , "~" , "approver_l" , "~" , approver , "|",line._document_number , "~" , "workflowStatus_l" , "~" , workflow , "|",line._document_number , "~" , "lineApprovalStatus_l" , "~" , replace(upper(workflow),"_"," ") , "|");

  }
  }
  else
  {
   // Mark auto-approval lines as approved. 
   if(line._part_number <> "")
   {
    sbappend(sbapprover, "");
    workflow = "approved";
    approver = sbtostring(sbapprover);
    sbappend(sb , line._document_number , "~" , "approver_l" , "~" , approver , "|",line._document_number , "~" , "workflowStatus_l" , "~" , workflow , "|",line._document_number , "~" , "lineApprovalStatus_l" , "~" , replace(upper(workflow),"_"," ") , "|");
   }
  }
 }
 }
 else
 {
  flag = true;
  for line in transactionLine{
   sbapprover = stringbuilder();
   workflow="pending_approval";
  if (line.approvalFlag_l){
  bu = line.businessDivision_l;
  part = line._part_number;
  if(part<>""){
  //first 2 levels of approval is over, reassign approvers for the 3rd level.
  if(levelup == 2){
  if(line.perUnitPerListPrice_l == 0 and line.proposedNetUnitPriceRequested_l > 0){
    sbappend(sbapprover,"");
   workflow="approved";
  }
  else
  { 
  if(line.proposedNetUnitPriceRequested_l >= line.salesMin3_l)
  {
   sbappend(sbapprover,"");
   workflow="approved";
  }

  else
  {
   // fetch BU approvers (based on product family for non-CA and Sales Area for CA quotes) and assign if proposed price < salesmin3
   sbfam = stringbuilder();

    resultSet = bmql("select PRODUCT_FAMILY from BRCM_Part_Master where MPN = $part");
    for each in resultSet{
     sbappend(sbfam, "%" , get(each,"PRODUCT_FAMILY") , "%");
    }
    fam = sbtostring(sbfam);
    if(startswith(dealType_t,"cAD")){
    resultSet = bmql("select User_Id, User_Name from Approval_PF_Mapping where User_Role = $buRole and Assigned_Region = $salesRegion");
    for record in resultSet
    {
     sbappend(sbapprover, "," ,  get(record,"User_Id"));
    }
    }
    else{
    resultSet = bmql("select User_Id, User_Name from Approval_PF_Mapping where User_Role = $buRole and Assigned_Region = $salesRegion and Assigned_PF like $fam");
    for record in resultSet
    {
     sbappend(sbapprover, "," ,  get(record,"User_Id"));
    }
    }
    flag = false;

  }
  }

   approver = sbtostring(sbapprover);
   sbappend(sb , line._document_number , "~" , "approver_l" , "~" , approver , "|",line._document_number , "~" , "workflowStatus_l" , "~" , workflow , "|",line._document_number , "~" , "lineApprovalStatus_l" , "~" , replace(upper(workflow),"_"," ") , "|");
  }
  else
  {
   //If all lines are fully approved, quote should be fully approved.
    if(levelup > 0){
    
    sbappend(sb,"1~status_t~APPROVED|");
    }
  }
 }
 }
 else
  {
   //mark auto-approved lines as approved.
   if(line._part_number <> "")
   {
    sbappend(sbapprover,"");
    workflow = "approved";
    approver = sbtostring(sbapprover);
    sbappend(sb , line._document_number , "~" , "approver_l" , "~" , approver , "|",line._document_number , "~" , "workflowStatus_l" , "~" , workflow , "|",line._document_number , "~" , "lineApprovalStatus_l" , "~" , replace(upper(workflow),"_"," ") , "|");

   }
  }
 } }
 
  //call OOTB approve action to advance approval level in the header level.
  response = commerce.approveOrReject_avg("approve_submit_t");
  
}
// if block for rejected
else 
{
 if(ret == "rejected")
 {
  //call OOTB reject action to stop the approval workflow in the header level.
  response = commerce.approveOrReject_avg("reject_submit_t");
  
  sbappend(sb,"1~status_t~REJECTED|");

  for line in transactionLine{
  if(line.workflowStatus_l <> "pending_approval"){
   
   sbappend(sb , line._document_number , "~lineApprovalStatus_l~" , replace(upper(line.workflowStatus_l),"_"," ") , "|");
  }
  else
  {
   
   sbappend(sb , line._document_number , "~lineApprovalStatus_l~" , "REJECTED" , "|");

  }
  }
 }
}



sbappend(sb , "1~approvalLevelCompleted_avg~" , String(levelup) ,"|");
result = sbtostring(sb);
return result;