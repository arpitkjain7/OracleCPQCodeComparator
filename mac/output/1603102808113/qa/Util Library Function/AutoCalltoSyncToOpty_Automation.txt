/************************************************
/Rule Name: AutoCalltoSyncToOpty_Automation
/Description: This program is responsible for Syncing the quotes generated by renewal program
/Author: M Vamsi Krishna
/Creation Date: 04-May-2020
History:
 Date          Author            Comment 
 04/05/2020    M Vamsi   VIPER-817 Create renewal automation process to generate renewal quotes 
*/
rret="";
BatchNumber=0;
batchCheck=0;
url="";
currentUser = "";
Credentials="";

if(find(Program_ID,"~") > 0){
 Details=split(Program_ID, "~");
 BatchNumber=atoi(Details[0]);
 currentUser=Details[1];
 
}
else{
//to fetch the latest batch number for the renewal program that was triggered this UTIL
result=bmql("Select Batch_Number from Renewal_Batch_Detail where Program_ID = $Program_ID");

for res in result
{
  BatchNumber = getint(res,"Batch_Number");
}
batchCheck=BatchNumber+1;
}
results=bmql("select Username,Password,SoapEndpoint from INT_SYSTEM_DETAILS where System='Create_Renewal_Trans_REST'");
 
 for res2 in results
 {
 Credentials_sb=stringbuilder();
 Credentials_sb = sbappend(Credentials_sb, get(res2,"Username"), ":", get(res2,"Password"));
 Credentials=sbtostring(Credentials_sb);
 url=get(res2,"SoapEndpoint");
 print Credentials;
 }

 http_Method="POST";
 
//Rest API Header details
 headersDict = dict("string"); 

 put(headersDict,"Content-Type","application/json");

 encodecredential=encodebase64(Credentials);
 authstring="Basic " + encodecredential;
 

 put(headersDict,"Authorization",authstring);
 print "headersDict";
 print headersDict;
 response=Dict("string");
 
if(find(Program_ID,"~") > 0){
result=bmql("Select Transaction_ID,OPTY_ID from BRCM_Renewal_Job where Batch_Number=$BatchNumber and ACCOUNT_TYPE<>'Commercial' and User = $currentUser");
for res in result
{
  TransactionID = get(res,"Transaction_ID");
  optyID=get(res,"OPTY_ID");
 
 if(optyID<>"")
 {
 OPENURL_sb = stringbuilder();
 OPENURL_sb = sbappend(OPENURL_sb, url, "/", TransactionID,"/actions/_open_transaction");
 
 OPENURL=sbtostring(OPENURL_sb);
 
 GETURL_sb = stringbuilder();
 GETURL_sb = sbappend(GETURL_sb, url, "/", TransactionID,"/actions/saveAndSyncItems");
 GETURL=sbtostring(GETURL_sb);
 
 response1 = urldata(OPENURL,http_Method,headersDict,"");
   
   
 response = urldata(GETURL,http_Method,headersDict,"");
 
  }
  }

}
else{
result=bmql("Select Transaction_ID,OPTY_ID from BRCM_Renewal_Job where Batch_Number=$BatchNumber and ACCOUNT_TYPE<>'Commercial' and User = $Program_ID"); 
for res in result
{
  TransactionID = get(res,"Transaction_ID");
  optyID=get(res,"OPTY_ID");
 
 if(optyID<>"")
 {
 OPENURL_sb = stringbuilder();
 OPENURL_sb = sbappend(OPENURL_sb, url, "/", TransactionID,"/actions/_open_transaction");
 
 OPENURL=sbtostring(OPENURL_sb);
 
 GETURL_sb = stringbuilder();
 GETURL_sb = sbappend(GETURL_sb, url, "/", TransactionID,"/actions/saveAndSyncItems");
 GETURL=sbtostring(GETURL_sb);
 
 response1 = urldata(OPENURL,http_Method,headersDict,"");
   
 response = urldata(GETURL,http_Method,headersDict,"");
 
  }
  }
}

return rret;