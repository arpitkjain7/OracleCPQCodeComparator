/************************************************
/Rule Name: Auto Call Sync To Opty
/*************************************************/
rret="";
BatchNumber=0;
batchCheck=0;
url="";

Credentials="";
result=bmql("Select Batch_Number from BRCM_Renewal_Batch");

for res in result
{
  BatchNumber = getint(res,"Batch_Number");
}
batchCheck=BatchNumber+1;
print "===============Sync to opty";
print BatchNumber;
print batchCheck;
results=bmql("select Username,Password,SoapEndpoint from INT_SYSTEM_DETAILS where System='Create_Renewal_Trans_REST'");
 
 for res2 in results
 {
 Credentials_sb=stringbuilder();
 Credentials_sb = sbappend(Credentials_sb, get(res2,"Username"), ":", get(res2,"Password"));
 Credentials=sbtostring(Credentials_sb);
 url=get(res2,"SoapEndpoint");
 print Credentials;
 }

 http_Method="POST";
 
//Rest API Header details
 headersDict = dict("string"); 

 put(headersDict,"Content-Type","application/json");

 encodecredential=encodebase64(Credentials);
 authstring="Basic " + encodecredential;
 

 put(headersDict,"Authorization",authstring);
 print "headersDict";
 print headersDict;
 response=Dict("string");
counter=0; 
result1=bmql("Select Transaction_ID,OPTY_ID from BRCM_Renewal_Job where Batch_Number=$batchCheck");
for res1 in result1
{
counter=1;
}
print counter;
if(counter==0)
{ 
result=bmql("Select Transaction_ID,OPTY_ID from BRCM_Renewal_Job where Batch_Number=$BatchNumber and ACCOUNT_TYPE<>'Commercial' and User = $Program_ID");


for res in result
{
print "=========== inside sync to opty logic";
  TransactionID = get(res,"Transaction_ID");
  optyID=get(res,"OPTY_ID");
 
 if(optyID<>"")
 {
 OPENURL_sb = stringbuilder();
 OPENURL_sb = sbappend(OPENURL_sb, url, "/", TransactionID,"/actions/_open_transaction");
 
 OPENURL=sbtostring(OPENURL_sb);
 
 print OPENURL;
 GETURL_sb = stringbuilder();
 GETURL_sb = sbappend(GETURL_sb, url, "/", TransactionID,"/actions/saveAndSyncItems");
 GETURL=sbtostring(GETURL_sb);
 
 
 print GETURL;
 response1 = urldata(OPENURL,http_Method,headersDict,"");
   
   
 response = urldata(GETURL,http_Method,headersDict,"");
 print "=============sync to opty response";
 print response;
 
  }
  }

}
return rret;