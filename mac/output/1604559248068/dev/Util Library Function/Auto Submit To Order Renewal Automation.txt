/************************************************
/Rule Name: Auto Submit To Order Renewal Automation
/Description: This program is responsible for order submitting the quotes generated by renewal program
/Author: M Vamsi Krishna
/Creation Date: 04-May-2020
History:
 Date          Author            Comment 
 04/05/2020    M Vamsi   VIPER-817 Create renewal automation process to generate renewal quotes 
*/
batchNumber = "";
payload = dict("string");
username = "";
password = "";
fileLocation = "";
soapendpoint = "";
adhocparams = string[];
userid = Program_ID;
//Pick the latest Batch Number based on the program that triggered this UTIL
if(find(Program_ID,"~") < 0){
result1 = bmql("select Batch_Number from Renewal_Batch_Detail where Program_ID = $Program_ID");
for res in result1
{
batchNumber = get(res, "Batch_Number");
}
}
else{
adhocparams = split(Program_ID,"~");
print adhocparams;
batchNumber = adhocparams[0];
userid = adhocparams[1];
}
res1 = bmql("select Username,Password,File_Location,SoapEndpoint from INT_SYSTEM_DETAILS where System = 'Renewal_Submit_To_Order'");

for each in res1
{
username = get(each,"Username");
password = get(each,"Password");
fileLocation = get(each,"File_Location");
soapendpoint = get(each,"SoapEndpoint");
}

renewalJobres = bmql("select Transaction_ID, Quote_Number from BRCM_Renewal_Job where Batch_Number = $batchNumber and ACCOUNT_TYPE = 'Commercial' and User = $userid");

for result in renewalJobres
{
transactionID = get(result, "Transaction_ID");
put(payload,"USERNAME", username);
put(payload,"PASSWORD", password);
put(payload,"bm_id", transactionID);
defaultErrorMessage="";
request=applytemplate(fileLocation,payload,defaultErrorMessage);
request = replace(request,"&lt;","<");
request= replace(request,"&gt;",">");
request = replace(request,"&quot;","\"");
headersDict = dict("string"); 
response="";

response = urldatabypost(soapendpoint,request, "",headersDict,true);

payload = dict("string");
}
return "";