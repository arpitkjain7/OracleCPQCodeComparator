/************************************************************************************************************
Description: This library function is used to populate all eligible discounts oo line items in a quote.
Return type: string
History:     Date          Author            Comment 
     22/01/2019    Satyabrata Acharya       
     18/07/2019    Mrinal Kumar         Added for 5410

************************************************************************************************************/
result = "";
dlim="~";
dend="|";
environment_type = "";
partnerEnabled = "";
partnerType = "";
promoEnabled = "";
currdate =getDate();
//discount variables 
envDisc = 0.0;
partnerDisc = 0.0;
listPrc = 0.0;
ExtListPrice = 0.0;
partner_disc = 0.0;
env_discount = 0.0;
promoDisc = 0.0; 
promo_disc = 0.0;
partnerDisc=0.0;
envDisc = 0.0;
promoDisc = 0.0;
partNum  = partNumber;
env_select = env_selected;

listPrice = atof(final_price) * quantity;

resultSet1 = bmql("select Environment_Type,Partner_Type,Start_Date,End_Date from BRCM_Part_Master_Prc where MPN = $partNum");
for each in resultSet1
 {
 if(get(each,"Start_Date")<>"" AND get(each,"End_Date")<>"")
  {
  if(strtojavadate(get(each,"Start_Date"),"yyyy-MM-dd HH:mm:ss") <= currdate AND strtojavadate(get(each,"End_Date"),"yyyy-MM-dd HH:mm:ss") >= currdate)
  {
  environment_type = get(each,"Environment_Type");
  partnerType = get(each,"Partner_Type");
  }
 }
}  
resultSet2 = bmql("select Partner_Enabled from BRCM_Part_Master_Ext where MPN = $partNum");
for value in resultSet2
 {
 partnerEnabled = get(value,"Partner_Enabled");
 promoEnabled = get(value,"Promotion_Enabled");
 } 
// start of environment discount logic    
if(environment_type <> "") 
 {
 env_disc_factor=1.0;    
 if(env_select <> "")
  {
  resultSet = bmql("select Production,Non_Production,Disaster_Recovery from BRCM_Environment_Tb where Environment_Type = $environment_type ");
  for record in resultSet
   {
   if(env_selected == "Production" )
    {
    env_disc_factor = getfloat(record,"Production");   
    }
   elif(env_selected == "Non Production" OR env_selected=="Production Limited Use")
    {
    env_disc_factor = getfloat(record,"Non_Production");
    }
   elif(env_selected == "Disaster Recovery" OR env_selected=="Non Production Limited Use")
    {
    env_disc_factor = getfloat(record,"Disaster_Recovery");
    }
   } 
  ExtListPrice = listPrice * env_disc_factor;
  }
 ExtListPrice = listPrice * env_disc_factor;
 }
else
 {
 ExtListPrice=listPrice;
 }
// end of environment discount logic

// start of partner discount

partnerRole = partner2Role_t;
//Added by Mrinal for 5410: Changed the partnerEnabled value from Y to Yes 
if(partnerEnabled  == "Yes")
 {
 resultSet3= bmql("select Resell,Fulfilment from BRCM_Partner_Type where Partner_Type =$partnerType");
 for val in resultSet3
  {
  if(partnerRole =="resales")
   {
   partner_disc = getfloat(val,"Resell");
   }
  elif(partnerRole =="fulfillment")
   {
   partner_disc = getfloat(val,"Fulfilment");
   }
  }
 partnerDisc = (ExtListPrice * partner_disc);
 ExtListPrice = (ExtListPrice - partnerDisc);    
}
// end of partner discount logic


return ExtListPrice;