/*****************************************************************
Author - Shivendra Sharma
Date - 19/08/2019
JIRA - VIPER-64
Summary - CFirst Quote Created from Opportunity should be marked as primary 
*****************************************************************/

ret="";
userpasscode="";
userpasscode1="";
str3="";
str2="";
OpptId=opportunityNumber_t;
TransId=bs_id;
Value = true;
sb = stringbuilder();

if(status_t=="DRAFT" OR status_t=="IN_PROGRESS")
{ 

//Fetching details from Integration table
 url="";
 Details=bmql("SELECT Username, Password, RestEndpoint FROM INT_SYSTEM_DETAILS WHERE System='Customer_Search_Number'");

 for detail in Details{
  url=get(detail,"RestEndpoint");
  Username=get(detail,"Username");
  Password=get(detail,"Password");
  userpasscode1=Username+":"+Password;
 }
// appending rest api with necessary parameters and Opty ID for web service call.
GETURL=url+"crmRestApi/resources/11.13.18.02/salesOrders/?q=OptyNumber="+OpptId;
str3=encodebase64(userpasscode1);
auth="Basic" + " " + str3;

defaultErrorMessage="";
headersDict = dict("string"); 
put(headersDict,"Content-Type","application/json"); 
put(headersDict,"Authorization",auth);

response=Dict("string");
//Fetching Quote details/response from OEC for the Opty Id
response = urldata(GETURL,"GET",headersDict, "5000");
str= get(response,"Message-Body");


jsonObj1=json(str);
//storing transaction Id's of all the quotes in oppty and storing it in TransactionId array.
TransactionId=jsonpathgetmultiple(jsonObj1,"$..ExternalReferenceNumber");
size=jsonarraysize(TransactionId);
jsonrange=range(size);
nCount = 0;


//Assigning primary quote= true in current quote if no quote is present in oppty.
if (size == 0){

 //sbappend(sb,"1~primaryQuote_t~",string(Value),"|");
 sbappend(sb,string(Value));
 ret = sbtostring(sb); 

 }
 
//Keeping primary quote = true for first quote in opty and restricting to make first quote false again manually.
if (size == 1){
for each in jsonrange{
 jsonGet = jsonarrayget(TransactionId,nCount);
 print jsonGet;
 if (jsonGet == TransId){
  sbappend(sb,string(Value));
  ret = sbtostring(sb); 
 }
    }
}

}
return ret;